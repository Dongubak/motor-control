# PyQt5 모터 제어 GUI

#gui #pyqt5 #interface #monitoring

> ← [[MOC-motor-control|진입점]] / [[202602051000-cross-coupling|Cross Coupling]]

## 개요

PyQt5 + pyqtgraph 기반의 EtherCAT 모터 제어 GUI.
motor_coupling.py (Cross Coupling 포함)를 백엔드로 사용한다.

```
python gui_motor_control.py
```

---

## GUI 구조

```
┌──────────────────────┬───────────────────────────────────────┐
│ Panel 1: 초기 설정    │ Panel 3: 모니터링                      │
│ - Adapter (ComboBox) │ - 상태 테이블                          │
│ - Motors (1~8)       │ - Sync 인디케이터                      │
│ - Cycle Time (ms)    │ - 위치 그래프 (pyqtgraph)              │
│ - 모터별 Axis/RPM    │ - 위치 차이 그래프                     │
│ [Start] [Stop]       │                                       │
├──────────────────────┤                                       │
│ Panel 2: 런타임 제어  │                                       │
│ - 원점 설정 / 이동    │                                       │
│ - Move All           │                                       │
│ - Cross Coupling     │                                       │
│   - Enable ☑         │                                       │
│   - Gain Slider      │                                       │
│ [Reset Sync Error]   │                                       │
└──────────────────────┴───────────────────────────────────────┘
```

---

## 클래스 구조

| 클래스 | 역할 |
|--------|------|
| `MotorSettingsWidget` | 모터별 초기 설정 (축, 속도, 가감속) |
| `InitialSettingsPanel` | Panel 1: 버스 + 모터 설정 |
| `MotorRuntimeWidget` | 모터별 런타임 제어 (원점, 이동) |
| `RuntimeControlPanel` | Panel 2: 이동 + Cross Coupling |
| `MonitoringPanel` | Panel 3: 테이블 + 그래프 |
| `MotorControlGUI` | 메인 윈도우 (상태 관리) |

---

## 상태 관리

```
idle ──[Start]──→ starting ──[OP 도달]──→ running
  ↑                   │                       │
  └───[Stop]──────────┴───────[Stop]──────────┘
```

| 상태 | Panel 1 | Panel 2 | 모니터링 |
|------|---------|---------|----------|
| `idle` | 활성화 | 비활성화 | 빈 상태 |
| `starting` | 비활성화 | 비활성화 | 대기 |
| `running` | 비활성화 | 활성화 | 실시간 |

---

## 파라미터 분류

### 시작 전 설정 (Panel 1)

| 파라미터 | 위젯 | 범위 |
|----------|------|------|
| Adapter | ComboBox (editable) | pysoem.find_adapters() |
| Num Motors | SpinBox | 1 ~ 8 |
| Cycle Time | SpinBox | 1 ~ 100 ms |
| Axis | RadioButton | X / Z |
| Velocity | SpinBox | 1 ~ 500 RPM |
| Accel/Decel | SpinBox | 1 ~ 1000 RPM/s |

### 런타임 변경 (Panel 2)

| 파라미터 | 위젯 | 범위 |
|----------|------|------|
| Target Position | DoubleSpinBox | -9999.99 ~ 9999.99 mm |
| Coupling Enable | CheckBox | on/off |
| Coupling Gain | Slider | 0.00 ~ 1.00 |
| Max Sync Error | DoubleSpinBox | 0.01 ~ 10.0 mm |

### 읽기 전용 (Panel 3)

| 데이터 | 표시 방식 |
|--------|-----------|
| Status Word | 테이블 (hex) |
| CiA 402 State | 테이블 (색상 코딩) |
| Position (mm) | 테이블 + 그래프 |
| Position (pulse) | 테이블 |
| Moving | 테이블 (파란색) |
| Position Diff | 라벨 + 그래프 |
| Sync Error | 인디케이터 (초록/빨강) |

---

## 실시간 그래프

### 위치 그래프
- X축: 시간 (초)
- Y축: 위치 (mm)
- 모터별 색상 (Motor 0: 파랑, Motor 1: 빨강, ...)
- 30초 롤링 윈도우
- `collections.deque(maxlen=300)` (100ms × 300 = 30초)

### 위치 차이 그래프
- |Motor 0 - Motor 1| 차이
- 빨간 점선: `max_sync_error` 임계값
- 임계값 초과 시 시각적 경고

---

## 시작 시퀀스

```python
# 1. 설정값 읽기
adapter = panel1.get_adapter()
num_motors = panel1.get_num_motors()
...

# 2. 버스 생성
bus = EtherCATBusCoupling(adapter, num_motors, ...)

# 3. 모터별 설정 (start 전!)
for motor in bus.motors:
    motor.set_axis('z')
    motor.set_profile_velocity(50)

# 4. 시작
bus.start()

# 5. OP 상태 폴링 (200ms × 50회 = 10초)
QTimer → _check_startup_ready()

# 6. 모니터링 시작 (100ms QTimer)
```

---

## 에러 처리

| 상황 | 처리 |
|------|------|
| 어댑터 미발견 | ComboBox editable → 직접 입력 |
| 시작 타임아웃 (10초) | QMessageBox → idle 복귀 |
| Sync Error | 빨간 인디케이터 + Reset 버튼 |
| 프로세스 비정상 종료 | 경고 → idle 복귀 |
| 창 닫기 (실행 중) | 확인 대화상자 → 안전 종료 |

---

## 의존성

```bash
pip install PyQt5 pyqtgraph
```

| 패키지 | 버전 | 용도 |
|--------|------|------|
| PyQt5 | 5.15+ | GUI 프레임워크 |
| pyqtgraph | 0.14+ | 실시간 그래프 |
| numpy | 2.2+ | 데이터 처리 |
| pysoem | 1.1+ | EtherCAT 통신 |

---

## 브랜치 정보

| 항목 | 값 |
|------|-----|
| 브랜치 | `crossCoupling` |
| 커밋 | `3808c78` |
| 파일 | `gui_motor_control.py` |

---

## 관련 노트

- [[202602051000-cross-coupling|Cross Coupling]] - 보정 알고리즘
- [[202602041300-safety-synchronization|안전 동기화]] - 위치 모니터링
- [[202602031206-main-execution-flow|실행 흐름]] - CLI 기반 제어 참조
- [[202602041400-git-github-setup|Git 연동]] - 저장소 정보

---

**생성일**: 2026-02-06
**태그**: #gui #pyqt5 #interface #monitoring #pyqtgraph

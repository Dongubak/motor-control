# CiA 402 상태 머신

#cia402 #state-machine #protocol

> ← [[MOC-motor-control|진입점]] / [[202602031200-ethercat-motor-control-system|시스템 개요]]

## 개요

CiA 402는 드라이브 및 모션 제어를 위한 표준 프로토콜이다. 상태 머신(State Machine)을 정의하여 모터의 전원 투입부터 동작까지의 단계를 표준화한다.

## 상태 다이어그램

```
[Power On]
    ↓
┌─────────────────────┐
│ Switch On Disabled  │ ← 0x0040
│     (상태 0)         │
└─────────────────────┘
    ↓ Shutdown (0x0006)
┌─────────────────────┐
│ Ready to Switch On  │ ← 0x0021
│     (상태 1)         │
└─────────────────────┘
    ↓ Switch On (0x0007)
┌─────────────────────┐
│   Switched On       │ ← 0x0023
│     (상태 2)         │
└─────────────────────┘
    ↓ Enable Operation (0x000F)
┌─────────────────────┐
│ Operation Enabled   │ ← 0x0027
│     (상태 3)         │  ← 모터 동작 가능!
└─────────────────────┘

    [Fault] ← 0x0008
    ↓ Fault Reset (0x0080)
    (상태 1로 복귀)
```

## Statusword 비트 구조

| 비트 | 이름 | 설명 |
|------|------|------|
| 0 | Ready to switch on | 전원 준비 완료 |
| 1 | Switched on | 스위치 온 상태 |
| 2 | Operation enabled | 동작 활성화 |
| 3 | Fault | 에러 발생 |
| 4 | Voltage enabled | 전압 활성화 |
| 5 | Quick stop | 급정지 |
| 6 | Switch on disabled | 스위치 비활성 |

## 상태 판정 로직

```python
# motor.py:347-360
if (status & 0x004F) == 0x0040:      # Switch On Disabled
    cw = CW_SHUTDOWN
elif (status & 0x006F) == 0x0021:    # Ready to Switch On
    cw = CW_SWITCH_ON
elif (status & 0x006F) == 0x0023:    # Switched On
    cw = CW_ENABLE_OPERATION
elif (status & 0x006F) == 0x0027:    # Operation Enabled
    cw = CW_ENABLE_OPERATION
elif (status & 0x0008):               # Fault
    cw = CW_FAULT_RESET
```

**위치**: [[202602031203-ethercat-process-loop|프로세스 루프]] 내부

## Controlword 명령

```python
# motor.py:7-12
CW_SHUTDOWN = 0x0006          # 전원 준비
CW_SWITCH_ON = 0x0007         # 스위치 온
CW_ENABLE_OPERATION = 0x000F  # 동작 활성화
CW_DISABLE_VOLTAGE = 0x0000   # 전압 차단
CW_FAULT_RESET = 0x0080       # 에러 리셋
```

## 초기화 시퀀스

메인 프로그램에서 상태 대기:

```python
# main.py:40-48
while (motor.status_word & 0x006F) != 0x0027:
    time.sleep(0.05)
    if time.monotonic() - start_time > 5:
        raise RuntimeError("모터가 Operation Enabled에 도달하지 못했습니다")
```

**목표 상태**: `0x0027` (Operation Enabled)
**타임아웃**: 5초

## 종료 시퀀스

안전한 종료를 위한 역순 전환:

```python
# motor.py:453-490
# 1단계: Disable Operation (0x0007)
#   Operation Enabled → Switched On

# 2단계: Shutdown (0x0006)
#   Switched On → Ready to Switch On

# 3단계: Disable Voltage (0x0000)
#   Ready to Switch On → Switch On Disabled

# 4단계: INIT 상태
#   EtherCAT 통신 종료
```

**대기 시간**: 각 단계마다 0.1~0.2초

## Fault 처리

[[202602031209-fault-handling|Fault 처리]] 참조

```python
# motor.py:356-358
elif (status & 0x0008):  # Fault
    cw = CW_FAULT_RESET
```

**자동 복구**: 프로세스 루프에서 자동으로 `CW_FAULT_RESET` 전송

## 상태 확인 헬퍼

```python
def _read_status_word(slave):
    return struct.unpack("<H", slave.input[:2])[0]
```

**위치**: `motor.py:500-501`

## 실무 팁

1. **초기화 대기**: OP 상태 전환 후 상태 안정화까지 시간 필요
2. **Fault 복구**: Fault Reset 후 Ready to Switch On까지 자동 전환
3. **안전 종료**: 역순으로 상태 전환하여 안전하게 종료

## 관련 표준 문서

- CiA 402 Device Profile for Drives and Motion Control
- IEC 61800-7-201:2007

## 관련 노트

- [[202602031203-ethercat-process-loop|EtherCAT 프로세스 루프]]
- [[202602031209-fault-handling|Fault 처리]]
- [[202602031206-main-execution-flow|메인 실행 흐름]]

---

**생성일**: 2026-02-03
**태그**: #protocol #standard #state-machine

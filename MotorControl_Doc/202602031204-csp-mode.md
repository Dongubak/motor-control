# CSP 모드 (Cyclic Synchronous Position Mode)

#ethercat #csp #control-mode

> ← [[MOC-motor-control|진입점]] / [[202602031200-ethercat-motor-control-system|시스템 개요]]

## 개요

CSP (Cyclic Synchronous Position Mode)는 EtherCAT의 **위치 동기화 제어 모드**이다. 마스터가 매 사이클마다 목표 위치를 전송하고, 드라이브가 이를 추종한다.

## 모드 번호

**CiA 402 모드**: `8`

```python
# motor.py:528
slave.sdo_write(0x6060, 0, struct.pack("<b", 8))
```

## PDO 매핑

### RxPDO (Master → Slave)

| 객체 | 이름 | 크기 | 설명 |
|------|------|------|------|
| 0x6040 | Controlword | 2 bytes | 제어 명령 |
| 0x607A | Target Position | 4 bytes | 목표 위치 (pulse) |

**구현**: `motor.py:535-541`

### TxPDO (Slave → Master)

| 객체 | 이름 | 크기 | 설명 |
|------|------|------|------|
| 0x6041 | Statusword | 2 bytes | 상태 정보 |
| 0x6064 | Position Actual Value | 4 bytes | 현재 위치 (pulse) |

**구현**: `motor.py:543-550`

## CSP vs Profile Position 비교

| 특성 | CSP 모드 | Profile Position 모드 |
|------|----------|----------------------|
| 제어 주체 | 마스터 | 드라이브 |
| 궤적 생성 | 마스터에서 보간 | 드라이브 내부 |
| 동기화 | 우수 (실시간) | 보통 |
| 통신 부하 | 높음 (매 사이클) | 낮음 (목표 전송 후 대기) |
| 유연성 | 매우 높음 | 낮음 |

**선택 이유**: [[202602031210-synchronization|다축 동기화]]를 위해 CSP 모드 사용

## 드라이버 특수 설정

```python
# motor.py:525
slave.sdo_write(0x211F, 0, struct.pack("<H", (1 << 12)))
```

**비트 12**: 절대 위치 모드 활성화

**제조사**: LS ELECTRIC EtherCAT Drive

## Following Error 설정

CSP 모드에서는 Following Error Window를 넉넉하게 설정해야 한다:

```python
# motor.py:114
slave.sdo_write(0x6065, 0, struct.pack("<I", 200000000))  # 200M pulse ≈ 143mm
```

**이유**: 마스터에서 궤적을 생성하므로, 초기에 목표와 현재 위치 차이가 클 수 있음

**관련**: [[202602031209-fault-handling|Fault 처리]]

## Position Window 설정

```python
# motor.py:106
slave.sdo_write(0x6067, 0, struct.pack("<I", 200000000))
```

**목적**: Target Reached 판정을 비활성화 (마스터가 직접 판정)

## 제어 흐름

```
1. 마스터: 목표 위치 계산 (S-Curve 보간)
2. 마스터: Controlword + Target Position 전송
3. 드라이브: 현재 위치로 빠르게 추종
4. 드라이브: Statusword + Actual Position 응답
5. 마스터: 위치 오차 확인
6. 반복 (10ms 주기)
```

**구현**: [[202602031203-ethercat-process-loop|EtherCAT 프로세스 루프]]

## 위치 완료 판정

드라이브의 Position Window를 사용하지 않고, 마스터에서 직접 판정:

```python
# motor.py:372, 387-392
position_error = abs(traj['end'] - current_actual_pos)
if position_error < 50000:  # 약 0.18mm
    state['trajectory'] = None  # 궤적 완료
```

**Threshold**: 50,000 pulse ≈ 0.18mm (z축 기준)

## 장점

1. **정밀한 동기화**: 모든 모터가 같은 사이클에서 목표 위치 수신
2. **유연한 궤적**: [[202602031207-trajectory-interpolation|S-Curve]] 등 임의 궤적 가능
3. **실시간 제어**: 외부 센서 피드백 반영 가능

## 단점

1. **통신 부하**: 매 사이클마다 통신 필요
2. **마스터 부하**: 모든 궤적을 마스터에서 계산
3. **지터 민감**: 사이클 타임이 불안정하면 진동 발생

## 관련 노트

- [[202602031203-ethercat-process-loop|EtherCAT 프로세스 루프]]
- [[202602031207-trajectory-interpolation|궤적 보간]]
- [[202602031210-synchronization|다축 동기화]]
- [[202602031208-position-control|위치 제어]]

---

**생성일**: 2026-02-03
**태그**: #control-mode #protocol

# 안전 동기화 분석

#safety #synchronization #critical-application

> ← [[MOC-motor-control|진입점]] / [[202602031200-ethercat-motor-control-system|시스템 개요]]

## 개요

중량물 리프팅 등 안전이 중요한 애플리케이션에서 다축 동기화의 안전성을 분석한다. [[202602031204-csp-mode|CSP 모드]]와 [[202602031210-synchronization|다축 동기화]]의 현재 구현 상태와 개선 방안을 다룬다.

## 시나리오: 중량물 리프팅

```
        무거운 파이프 (중량물)
    ┌─────────────────────────┐
    │                         │
  ▲ │                         │ ▲
Motor 0                    Motor 1
(Slave 0)                 (Slave 1)

※ 동기 불일치 시 → 파이프 기울어짐 → 낙하 사고!
```

**위험 요소**:
- 한쪽 모터만 동작하면 중량물이 기울어짐
- 위치 차이가 커지면 낙하 또는 파손 위험
- 기계적 손상 및 인명 피해 가능

---

## 현재 구현 분석

### 동기화 방식 (현재)

| 항목 | 구현 여부 | 코드 위치 |
|------|----------|-----------|
| 명령 동기화 (같은 목표) | ✅ | `motor.py:236` |
| 시간 동기화 (같은 duration) | ✅ | `motor.py:281-282` |
| DC Sync (하드웨어 동기화) | ✅ | `motor.py:82` |
| **실제 위치 모니터링** | ❌ | - |
| **위치 차이 검출** | ❌ | - |
| **차이 초과 시 정지** | ❌ | - |
| Fault 연동 정지 | ✅ | `motor.py:320-328` |

### 현재 구현의 한계

```python
# motor.py:305-307 - 현재 구현
master.send_processdata()    # 명령 전송
master.receive_processdata() # 상태 수신

# ❌ 문제점:
# 1. 두 모터의 실제 위치 차이를 확인하지 않음
# 2. Motor 0이 50mm, Motor 1이 30mm여도 감지 못함
# 3. Fault가 발생해야만 정지됨
```

### 위험 시나리오

```
시간 ────────────────────────────────────────→

Motor 0:  0mm ──────────────────→ 50mm (정상)
Motor 1:  0mm ─────→ 20mm (지연/오류)
                      ↑
              ⚠️ 위치 차이 30mm 발생!
              현재 코드는 이를 감지하지 못함
```

---

## CSP 모드의 적합성

### CSP 모드가 안전 동기화에 적합한 이유

| 특성 | 설명 | 안전 기여 |
|------|------|----------|
| 매 사이클 통신 | 10ms마다 명령/상태 교환 | 빠른 감지 가능 |
| 실시간 피드백 | 실제 위치 즉시 확인 | 차이 계산 가능 |
| DC Sync | 나노초 단위 동기화 | 정밀한 타이밍 |
| 마스터 제어 | 모든 결정을 마스터가 수행 | 중앙 집중 안전 로직 |

### 결론

> **CSP 모드 자체는 안전 동기화에 적합하다.**
> **하지만 현재 구현에 위치 차이 모니터링 로직이 없어 불완전하다.**

---

## 개선 방안: 위치 차이 모니터링

### 추가해야 할 로직

```python
# motor.py:309 근처에 추가
# _ethercat_process_loop() 함수 내부

# [안전 동기화] 위치 차이 모니터링
if num_slaves >= 2:
    # 1. 모든 모터의 실제 위치 읽기
    positions = [_read_actual_position(master.slaves[i]) for i in range(num_slaves)]

    # 2. 위치 차이 계산 (인접 모터 간)
    for i in range(num_slaves - 1):
        position_diff = abs(positions[i] - positions[i + 1])

        # 3. 임계값 초과 시 긴급 정지
        MAX_SYNC_ERROR = 100000  # 약 0.36mm (z축 기준)

        if position_diff > MAX_SYNC_ERROR:
            print(f"[긴급 정지] 동기화 오류! Motor {i} vs {i+1}: diff={position_diff} pulse")

            # 모든 모터 즉시 정지
            for j in range(num_slaves):
                local_motor_states[j]['trajectory'] = None
                local_motor_states[j]['target_pulse'] = positions[j]

            # 에러 플래그 설정
            sync_error_detected = True
            break
```

### 구현 위치

**파일**: `motor.py`
**함수**: `_ethercat_process_loop()`
**위치**: PDO 통신 후, 제어 로직 전 (약 309번 줄)

```
┌─────────────────────────────────────────────────────┐
│           프로세스 루프 (10ms 주기)                   │
├─────────────────────────────────────────────────────┤
│ 1. 명령 큐 처리                                      │
│ 2. PDO 통신 (send/receive)                          │
│ 3. ⭐ [신규] 위치 차이 모니터링                       │
│ 4. ⭐ [신규] 차이 초과 시 긴급 정지                   │
│ 5. Fault 확인                                       │
│ 6. 상태 머신 및 궤적 제어                            │
│ 7. 공유 메모리 업데이트                              │
└─────────────────────────────────────────────────────┘
```

---

## 안전 수준 비교

| Level            | 구현 내용                       | 안전성       | 적용 대상  |
| ---------------- | --------------------------- | --------- | ------ |
| **Level 0** (현재) | 명령 동기화만                     | ⚠️ 낮음     | 테스트용   |
| **Level 1**      | + 위치 차이 모니터링 + 소프트웨어 정지     | ✅ 보통      | 일반 산업용 |
| **Level 2**      | + Cross Coupling (상호 위치 보정) | ✅✅ 높음     | 정밀 동기화 |
| **Level 3**      | + 하드웨어 인터락 + STO            | ✅✅✅ 매우 높음 | 안전 중요  |

### Level별 상세

#### Level 1: 위치 차이 모니터링
- 소프트웨어로 위치 차이 감지
- 임계값 초과 시 정지 명령 전송
- 구현 난이도: 낮음

#### Level 2: Cross Coupling
- 두 모터의 위치 오차를 상호 보정
- 한 모터가 느리면 다른 모터도 속도 조절
- 구현 난이도: 중간

#### Level 3: 하드웨어 안전
- STO (Safe Torque Off) 기능
- 하드웨어 인터락 회로
- 안전 PLC 연동
- 구현 난이도: 높음 (하드웨어 필요)

---

## 임계값 설정 가이드

### 위치 차이 임계값 계산

**z축 기준**:
```
1 pulse = 5.9997mm / (8,388,608 × 2) = 0.000357 mm

허용 오차 1mm:
1mm / 0.000357mm = 약 2,800,000 pulse

허용 오차 0.1mm:
0.1mm / 0.000357mm = 약 280,000 pulse
```

### 권장 임계값

| 애플리케이션 | 허용 오차 | 임계값 (pulse) |
|-------------|----------|----------------|
| 일반 이송 | 1mm | 2,800,000 |
| 정밀 조립 | 0.1mm | 280,000 |
| **중량물 리프팅** | **0.5mm** | **1,400,000** |
| 초정밀 | 0.01mm | 28,000 |

---

## 권장 사항

### 중량물 리프팅 애플리케이션

1. ✅ **필수**: 위치 차이 모니터링 로직 추가
2. ✅ **필수**: 임계값 초과 시 즉시 정지
3. ⚠️ **권장**: Cross Coupling 구현
4. ⚠️ **권장**: 하드웨어 인터락 추가
5. ⚠️ **고려**: 안전 PLC 또는 STO 기능

### 구현 우선순위

```
[1순위] 위치 차이 모니터링 + 긴급 정지
         ↓
[2순위] 임계값 튜닝 및 테스트
         ↓
[3순위] Cross Coupling (선택)
         ↓
[4순위] 하드웨어 안전 (선택)
```

---

## 관련 노트

- [[202602031204-csp-mode|CSP 모드]] - 기본 동작 원리
- [[202602031210-synchronization|다축 동기화]] - 동기화 알고리즘
- [[202602031209-fault-handling|Fault 처리]] - 에러 복구
- [[202602031203-ethercat-process-loop|EtherCAT 프로세스 루프]] - 구현 위치

---

**생성일**: 2026-02-04
**태그**: #safety #critical #synchronization #improvement
